# tmux session/window/pane tree view
tmux-ls() {
    local session="${1:-}"

    _tmux_get_node_info() {
        local pane_pid="$1"
        # ìžì‹ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤ì œ ì‹¤í–‰ ì¤‘ì¸ ëª…ë ¹ í™•ì¸
        local child_cmd=$(ps -eo pid,ppid,args | awk -v ppid="$pane_pid" '$2==ppid {print $0; exit}')
        if [[ -z "$child_cmd" ]]; then
            echo "node|"
            return
        fi
        # gemini/codex ê°ì§€
        if [[ "$child_cmd" == *"/gemini"* || "$child_cmd" == *"gemini "* ]]; then
            echo "gemini|"
        elif [[ "$child_cmd" == *"/codex"* || "$child_cmd" == *"codex "* ]]; then
            echo "codex|"
        else
            # ì¼ë°˜ node - ìŠ¤í¬ë¦½íŠ¸ ì´ë¦„ ì¶”ì¶œ
            local script=$(echo "$child_cmd" | sed -E 's/.*node[^ ]* +//' | awk '{print $1}')
            script="${script##*/}"  # basename
            echo "node|$script"
        fi
    }

    _tmux_format_pane() {
        local line="$1"
        local idx cmd ppath title active pane_id pane_pid short_path icon info marker

        idx="${line%%|*}"; line="${line#*|}"
        cmd="${line%%|*}"; line="${line#*|}"
        ppath="${line%%|*}"; line="${line#*|}"
        title="${line%%|*}"; line="${line#*|}"
        active="${line%%|*}"; line="${line#*|}"
        pane_id="${line%%|*}"; line="${line#*|}"
        pane_pid="$line"

        # ê²½ë¡œ ì¶•ì•½
        short_path="${ppath/#$HOME/~}"
        [[ ${#short_path} -gt 30 ]] && short_path="â€¦/${ppath:t:h}/${ppath:t}"

        icon=""
        local extra=""

        # nodeì¸ ê²½ìš° ì‹¤ì œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
        if [[ "$cmd" == "node" ]]; then
            local node_info=$(_tmux_get_node_info "$pane_pid")
            local real_cmd="${node_info%%|*}"
            local script="${node_info#*|}"
            cmd="$real_cmd"
            [[ -n "$script" ]] && extra=" ($script)"
        fi

        # ì´ëª¨ì§€ ì„¤ì •
        case "$cmd" in
            claude) icon="ðŸ¤– " ;;
            gemini) icon="ðŸ• " ;;
            codex)  icon="ðŸ± " ;;
            node)   icon="ðŸ“¦ " ;;
        esac

        info="$cmd$extra $short_path"

        # AI ë„êµ¬ì¸ ê²½ìš° íƒ€ì´í‹€ ì¶”ê°€
        if [[ "$cmd" == "claude" || "$cmd" == "gemini" || "$cmd" == "codex" ]]; then
            if [[ -n "$title" ]]; then
                # spinner ë¬¸ìž ì œê±°
                title="${title#â ‹ }"; title="${title#â ™ }"; title="${title#â ¹ }"; title="${title#â ¸ }"
                title="${title#â ¼ }"; title="${title#â ´ }"; title="${title#â ¦ }"; title="${title#â § }"
                title="${title#â ‡ }"; title="${title#â  }"; title="${title#â  }"; title="${title#â ‚ }"; title="${title#â ˆ }"
                [[ -n "$title" ]] && info="$cmd \"$title\" $short_path"
            fi
        fi

        marker=""
        [[ "$active" == "1" ]] && marker=" *"
        printf "    â””â”€ %s: %s%s%s [%s]\n" "$idx" "$icon" "$info" "$marker" "$pane_id"
    }

    _tmux_show_session() {
        local sess="$1" win_list pane_list win pane
        printf "ðŸ“¦ %s\n" "$sess"
        win_list=$(tmux list-windows -t "$sess" -F "#{window_index}:#{window_name}")
        for win in ${(f)win_list}; do
            printf "  ðŸ“ %s\n" "$win"
            pane_list=$(tmux list-panes -t "$sess:${win%%:*}" -F "#{pane_index}|#{pane_current_command}|#{pane_current_path}|#{pane_title}|#{pane_active}|#{pane_id}|#{pane_pid}")
            for pane in ${(f)pane_list}; do
                _tmux_format_pane "$pane"
            done
        done
    }

    if [[ -z "$session" ]]; then
        local sess_list sess
        sess_list=$(tmux list-sessions -F "#{session_name}" 2>/dev/null)
        for sess in ${(f)sess_list}; do
            _tmux_show_session "$sess"
        done
    else
        if ! tmux has-session -t "$session" 2>/dev/null; then
            echo "Session '$session' not found"
            return 1
        fi
        _tmux_show_session "$session"
    fi
    echo ""
    echo "ðŸ’¡ Kill: tmux-kill %ID [%ID2 ...]"
}

# tmux kill pane shortcut
tmux-kill() {
    if [[ -z "$1" ]]; then
        echo "Usage: tmux-kill %ID [%ID2 ...]"
        return 1
    fi
    local p
    for p in "$@"; do
        tmux kill-pane -t "$p" && echo "Killed $p" || echo "Failed to kill $p"
    done
}
